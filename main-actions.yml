name: main-actions

on:  
  push:
    branches: [ main ]

env:
  SOLUTION_FILE_PATH: .\workflow-actions.sln
  
  TEST_FILE_PATH: .\PLC.Test\bin\Debug\PLC.Test.dll
  
  TEST_LOG_PATH: .\TestResults\*.trx
  
  BUILD_CONFIGURATION: Debug

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v2

    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v1.0.2

    - name: Restore NuGet packages
      working-directory: ${{env.GITHUB_WORKSPACE}}
      run: nuget restore ${{env.SOLUTION_FILE_PATH}}

    - name: Setup VSTest
      uses: darenm/Setup-VSTest@v1

    - name: Build
      working-directory: ${{env.GITHUB_WORKSPACE}}
      # Add additional options to the MSBuild command line here (like platform or verbosity level).
      # See https://docs.microsoft.com/visualstudio/msbuild/msbuild-command-line-reference
      run: msbuild /m /p:Configuration=${{env.BUILD_CONFIGURATION}} ${{env.SOLUTION_FILE_PATH}}

    - name: Validate Automapper Configs
      run: .\PLC.AutoMapperConfigTest\bin\Debug\PLC.AutoMapperConfigTest.exe test

    - name: Run Tests
      run: vstest.console.exe ${{env.TEST_FILE_PATH}} /logger:trx
     
    - name: Test Report
      uses: dorny/test-reporter@v1
      if: success() || failure()   
      with:
        name: MYPLC Tests       
        path: ${{env.TEST_LOG_PATH}}
        reporter: dotnet-trx   
        path-replace-backslashes: 'true'    
